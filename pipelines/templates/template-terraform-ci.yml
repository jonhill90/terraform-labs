parameters:
  - name: artifactName
    type: string
  - name: team
    type: string
  - name: branchFilter
    type: object
    default: ["main"]
  - name: pathFilter
    type: string
    default: "security/**"
  - name: agentPool
    type: string
    default: "Lab"

name: ${{ parameters.team }}-CI-$(Build.SourceBranchName)-$(Build.BuildId)

trigger:
  branches:
    include: ${{ parameters.branchFilter }}
  paths:
    include:
      - ${{ parameters.pathFilter }}

pool:
  name: '${{ parameters.agentPool }}'

variables:
  - name: artifactName
    value: ${{ parameters.artifactName }}
  - name: team
    value: ${{ parameters.team }}

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: Build
        displayName: 'Prepare Terraform Artifacts'
        steps:
          - checkout: self
            fetchDepth: 1 

          - task: CopyFiles@2
            displayName: 'Copy ${{ parameters.team }} Terraform Files'
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/${{ parameters.team }}'
              Contents: '**'
              TargetFolder: '$(Build.ArtifactStagingDirectory)/$(artifactName)/${{ parameters.team }}'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Terraform Artifacts'
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)/$(artifactName)'
              artifactName: '$(artifactName)'